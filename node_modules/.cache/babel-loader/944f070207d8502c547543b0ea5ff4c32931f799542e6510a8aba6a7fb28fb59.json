{"ast":null,"code":"import _objectSpread from\"C:/Users/lucas/Downloads/Minimarket PRO/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect}from'react';import SaleForm from'./SaleForm';import SalesHistory from'./SalesHistory';import{isAdmin,getCurrentMarket,isMarket,isVendedor}from'../utils/auth';import{getAllData,putData,syncLocalStorageWithIndexedDB}from'../utils/indexedDb';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const SalesDashboard=_ref=>{let{isOnline,selectedMarket}=_ref;const[sales,setSales]=useState([]);const[products,setProducts]=useState([]);const[showForm,setShowForm]=useState(false);useEffect(()=>{const loadData=async()=>{const allSales=await getAllData('sales');const allProducts=await getAllData('products');const marketToShow=isAdmin()?selectedMarket:getCurrentMarket();const filteredSales=isAdmin()&&selectedMarket?allSales.filter(s=>s.marketId===selectedMarket):allSales.filter(s=>s.marketId===marketToShow);const filteredProducts=isAdmin()&&selectedMarket?allProducts.filter(p=>p.marketId===selectedMarket):allProducts.filter(p=>p.marketId===marketToShow);setSales(filteredSales);setProducts(filteredProducts);};loadData();},[selectedMarket]);const saveSales=async updatedSales=>{setSales(updatedSales);syncLocalStorageWithIndexedDB('sales',updatedSales);};const handleAddSale=async sale=>{const newSales=[...sales,sale];await putData('sales',sale);saveSales(newSales);const allExistingProducts=await getAllData('products');const updatedProducts=allExistingProducts.map(product=>{const soldItem=sale.items.find(item=>item.productId===product.id);if(soldItem){let remainingQuantity=soldItem.quantity;const sortedLots=[...product.lots].sort((a,b)=>new Date(a.expiryDate)-new Date(b.expiryDate));const updatedLots=[];for(let i=0;i<sortedLots.length&&remainingQuantity>0;i++){const currentLot=_objectSpread({},sortedLots[i]);if(currentLot.quantity>=remainingQuantity){currentLot.quantity-=remainingQuantity;remainingQuantity=0;}else{remainingQuantity-=currentLot.quantity;currentLot.quantity=0;}updatedLots.push(currentLot);}const finalLots=updatedLots.filter(lot=>lot.quantity>0);const newTotalStock=finalLots.reduce((sum,lot)=>sum+lot.quantity,0);return _objectSpread(_objectSpread({},product),{},{stock:newTotalStock,lots:finalLots});}return product;});for(const product of updatedProducts){await putData('products',product);}syncLocalStorageWithIndexedDB('products',updatedProducts);setProducts(updatedProducts.filter(p=>p.marketId===(isAdmin()?selectedMarket:getCurrentMarket())));setShowForm(false);};if(!isAdmin()&&!isMarket()&&!isVendedor()){return/*#__PURE__*/_jsx(\"div\",{className:\"text-center py-10 text-gray-800 dark:text-white\",children:\"Acceso no autorizado\"});}return/*#__PURE__*/_jsxs(\"div\",{className:\"bg-white p-6 rounded-lg shadow-md dark:bg-gray-800\",children:[/*#__PURE__*/_jsx(\"h2\",{className:\"text-2xl font-bold text-gray-800 dark:text-white mb-6\",children:\"Gesti\\xF3n de Ventas\"}),(isAdmin()||isMarket()||isVendedor())&&/*#__PURE__*/_jsx(\"button\",{onClick:()=>setShowForm(true),className:\"bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors\",children:\"Nueva Venta\"}),showForm&&/*#__PURE__*/_jsx(SaleForm,{products:products,onAddSale:handleAddSale,onCancel:()=>setShowForm(false)}),/*#__PURE__*/_jsx(SalesHistory,{sales:sales,products:products})]});};export default SalesDashboard;","map":{"version":3,"names":["React","useState","useEffect","SaleForm","SalesHistory","isAdmin","getCurrentMarket","isMarket","isVendedor","getAllData","putData","syncLocalStorageWithIndexedDB","jsx","_jsx","jsxs","_jsxs","SalesDashboard","_ref","isOnline","selectedMarket","sales","setSales","products","setProducts","showForm","setShowForm","loadData","allSales","allProducts","marketToShow","filteredSales","filter","s","marketId","filteredProducts","p","saveSales","updatedSales","handleAddSale","sale","newSales","allExistingProducts","updatedProducts","map","product","soldItem","items","find","item","productId","id","remainingQuantity","quantity","sortedLots","lots","sort","a","b","Date","expiryDate","updatedLots","i","length","currentLot","_objectSpread","push","finalLots","lot","newTotalStock","reduce","sum","stock","className","children","onClick","onAddSale","onCancel"],"sources":["C:/Users/lucas/Downloads/Minimarket PRO/src/components/SalesDashboard.js"],"sourcesContent":["import React, { useState, useEffect } from 'react';\r\nimport SaleForm from './SaleForm';\r\nimport SalesHistory from './SalesHistory';\r\nimport { isAdmin, getCurrentMarket, isMarket, isVendedor } from '../utils/auth';\r\nimport { getAllData, putData, syncLocalStorageWithIndexedDB } from '../utils/indexedDb';\r\n\r\nconst SalesDashboard = ({ isOnline, selectedMarket }) => {\r\n  const [sales, setSales] = useState([]);\r\n  const [products, setProducts] = useState([]);\r\n  const [showForm, setShowForm] = useState(false);\r\n\r\n  useEffect(() => {\r\n    const loadData = async () => {\r\n      const allSales = await getAllData('sales');\r\n      const allProducts = await getAllData('products');\r\n      \r\n      const marketToShow = isAdmin() ? selectedMarket : getCurrentMarket();\r\n      const filteredSales = isAdmin() && selectedMarket ? \r\n        allSales.filter(s => s.marketId === selectedMarket) : \r\n        allSales.filter(s => s.marketId === marketToShow);\r\n      \r\n      const filteredProducts = isAdmin() && selectedMarket ? \r\n        allProducts.filter(p => p.marketId === selectedMarket) : \r\n        allProducts.filter(p => p.marketId === marketToShow);\r\n\r\n      setSales(filteredSales);\r\n      setProducts(filteredProducts);\r\n    };\r\n    loadData();\r\n  }, [selectedMarket]);\r\n\r\n  const saveSales = async (updatedSales) => {\r\n    setSales(updatedSales);\r\n    syncLocalStorageWithIndexedDB('sales', updatedSales);\r\n  };\r\n\r\n  const handleAddSale = async (sale) => {\r\n    const newSales = [...sales, sale];\r\n    await putData('sales', sale);\r\n    saveSales(newSales);\r\n    \r\n    const allExistingProducts = await getAllData('products');\r\n    const updatedProducts = allExistingProducts.map(product => {\r\n      const soldItem = sale.items.find(item => item.productId === product.id);\r\n      if (soldItem) {\r\n        let remainingQuantity = soldItem.quantity;\r\n        const sortedLots = [...product.lots].sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));\r\n        const updatedLots = [];\r\n\r\n        for (let i = 0; i < sortedLots.length && remainingQuantity > 0; i++) {\r\n          const currentLot = { ...sortedLots[i] };\r\n          if (currentLot.quantity >= remainingQuantity) {\r\n            currentLot.quantity -= remainingQuantity;\r\n            remainingQuantity = 0;\r\n          } else {\r\n            remainingQuantity -= currentLot.quantity;\r\n            currentLot.quantity = 0;\r\n          }\r\n          updatedLots.push(currentLot);\r\n        }\r\n        \r\n        const finalLots = updatedLots.filter(lot => lot.quantity > 0);\r\n        const newTotalStock = finalLots.reduce((sum, lot) => sum + lot.quantity, 0);\r\n\r\n        return {\r\n          ...product,\r\n          stock: newTotalStock,\r\n          lots: finalLots\r\n        };\r\n      }\r\n      return product;\r\n    });\r\n    \r\n    for (const product of updatedProducts) {\r\n      await putData('products', product);\r\n    }\r\n    syncLocalStorageWithIndexedDB('products', updatedProducts);\r\n    \r\n    setProducts(updatedProducts.filter(p => p.marketId === (isAdmin() ? selectedMarket : getCurrentMarket())));\r\n    \r\n    setShowForm(false);\r\n  };\r\n\r\n  if (!isAdmin() && !isMarket() && !isVendedor()) {\r\n    return <div className=\"text-center py-10 text-gray-800 dark:text-white\">Acceso no autorizado</div>;\r\n  }\r\n\r\n  return (\r\n    <div className=\"bg-white p-6 rounded-lg shadow-md dark:bg-gray-800\">\r\n      <h2 className=\"text-2xl font-bold text-gray-800 dark:text-white mb-6\">Gesti√≥n de Ventas</h2>\r\n      {(isAdmin() || isMarket() || isVendedor()) && (\r\n        <button\r\n          onClick={() => setShowForm(true)}\r\n          className=\"bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors\"\r\n        >\r\n          Nueva Venta\r\n        </button>\r\n      )}\r\n\r\n      {showForm && (\r\n        <SaleForm\r\n          products={products}\r\n          onAddSale={handleAddSale}\r\n          onCancel={() => setShowForm(false)}\r\n        />\r\n      )}\r\n\r\n      <SalesHistory sales={sales} products={products} />\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default SalesDashboard;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}